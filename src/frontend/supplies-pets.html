<section id="supplies-pets" class="screen hidden" aria-labelledby="suppliesPetsH2">
  <div class="section">
    <h2 id="suppliesPetsH2">Food Pantry • Pet Information (up to 6)</h2>
    <p class="hint">Enable a card to add a pet. All pets share the same household/client.</p>

    <div class="pet-grid" id="petGrid"><!-- Pet cards injected by JS --></div>

    <div class="controls">
      <button type="button" class="btn secondary" data-nav="supplies-client">Back</button>
      <button type="button" class="btn primary" id="petsContinueBtn">
        <span class="btn-label">Continue to Supplies</span>
        <span class="spinner" aria-hidden="true" style="display:none;"></span>
      </button>
    </div>
  </div>
</section>

<script>
(() => {
  const scr  = document.getElementById('supplies-pets');
  if (!scr) return;

  const grid = scr.querySelector('#petGrid');
  const btn  = scr.querySelector('#petsContinueBtn');
  const spin = btn?.querySelector('.spinner');

  const host = scr.closest('#app') || document;
  const showScreen = (id) => {
    host.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    host.querySelector('#' + id)?.classList.remove('hidden');
  };
  const disableBtn = (b, s, on) => { if (!b) return; b.disabled = !!on; if (s) s.style.display = on ? 'inline-block' : 'none'; };

  const speciesOpts = ['Dog','Cat','Other'];
  const sexOpts     = ['Male','Female','Unknown'];
  const idFor       = (name, idx) => `${name}_${idx}`;

  function petCardTemplate(idx) {
    return `
      <div class="card pet-card" data-idx="${idx}">
        <!-- Hidden PetID for upsert -->
        <input type="hidden" class="pet-id" id="${idFor('petid', idx)}" value="">

        <div class="card-header">
          <label class="toggle">
            <input type="checkbox" class="pet-enabled" id="${idFor('enabled', idx)}"> Enable Pet ${idx + 1}
          </label>
        </div>

        <div class="card-body grid cols-3 disabled-fields">
          <div class="field">
            <label for="${idFor('name', idx)}">Name</label>
            <input id="${idFor('name', idx)}" class="pet-name" type="text" placeholder="Bella">
          </div>
          <div class="field">
            <label for="${idFor('species', idx)}">Species</label>
            <select id="${idFor('species', idx)}" class="pet-species">
              ${speciesOpts.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label for="${idFor('breed', idx)}">Breed</label>
            <input id="${idFor('breed', idx)}" class="pet-breed" type="text" placeholder="Mix">
          </div>

          <div class="field">
            <label for="${idFor('sex', idx)}">Sex</label>
            <select id="${idFor('sex', idx)}" class="pet-sex">
              ${sexOpts.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label for="${idFor('age', idx)}">Age (years)</label>
            <input id="${idFor('age', idx)}" class="pet-age" type="number" min="0" step="0.1" inputmode="decimal" placeholder="3">
          </div>
          <div class="field">
            <label for="${idFor('weight', idx)}">Weight (lbs)</label>
            <input id="${idFor('weight', idx)}" class="pet-weight" type="number" min="0" step="0.1" inputmode="decimal" placeholder="22">
          </div>

          <div class="field">
            <label><input type="checkbox" class="pet-fixed" id="${idFor('fixed', idx)}"> Spayed/Neutered</label>
          </div>
          <div class="field">
            <label><input type="checkbox" class="pet-deceased" id="${idFor('deceased', idx)}"> Deceased</label>
          </div>
          <div class="field">
            <label><input type="checkbox" class="pet-rehomed" id="${idFor('rehomed', idx)}"> Re-homed</label>
          </div>

          <div class="field col-span-3">
            <label for="${idFor('notes', idx)}">Notes</label>
            <input id="${idFor('notes', idx)}" class="pet-notes" type="text" placeholder="Allergies, diet, meds…">
          </div>
        </div>
      </div>
    `;
  }

  function setCardEnabled(card, on) {
    const body = card.querySelector('.card-body');
    const toggle = card.querySelector('.pet-enabled');
    if (toggle) toggle.checked = !!on;
    card.classList.toggle('active', !!on);
    body.classList.toggle('disabled-fields', !on);
    body.querySelectorAll('input,select,textarea').forEach(el => el.disabled = !on);
  }

  function fillCard(card, p) {
    setCardEnabled(card, true);
    const q = (sel) => card.querySelector(sel);

    q('.pet-id').value               = p.PetID || '';
    q('.pet-name').value             = p.Name || '';
    q('.pet-species').value          = p.Species || 'Dog';
    q('.pet-breed').value            = p.Breed || '';
    q('.pet-sex').value              = p.Sex || 'Unknown';
    q('.pet-age').value              = (p.AgeYrs ?? '');
    q('.pet-weight').value           = (p.WeightLbs ?? '');
    q('.pet-fixed').checked          = !!p.Fixed;
    q('.pet-deceased').checked       = !!p.Deceased;
    q('.pet-rehomed').checked        = !!p.Rehomed;
    q('.pet-notes').value            = p.Notes || '';
  }

  function buildGrid() {
    grid.innerHTML = '';
    for (let i = 0; i < 6; i++) grid.insertAdjacentHTML('beforeend', petCardTemplate(i));
    grid.querySelectorAll('.pet-card').forEach(card => {
      const t = card.querySelector('.pet-enabled');
      setCardEnabled(card, false);
      t?.addEventListener('change', () => setCardEnabled(card, t.checked));
    });
  }

  function serializePets() {
    const out = [];
    grid.querySelectorAll('.pet-card').forEach(card => {
      const enabledEl = card.querySelector('.pet-enabled');
      if (!enabledEl?.checked) return;

      const pet = {
        PetID:     card.querySelector('.pet-id')?.value?.trim() || '',
        Name:      card.querySelector('.pet-name')?.value?.trim() || '',
        Species:   card.querySelector('.pet-species')?.value || '',
        Breed:     card.querySelector('.pet-breed')?.value?.trim() || '',
        Sex:       card.querySelector('.pet-sex')?.value || '',
        AgeYrs:    Number(card.querySelector('.pet-age')?.value || '') || '',
        WeightLbs: Number(card.querySelector('.pet-weight')?.value || '') || '',
        Fixed:     !!card.querySelector('.pet-fixed')?.checked,
        Deceased:  !!card.querySelector('.pet-deceased')?.checked,
        Rehomed:   !!card.querySelector('.pet-rehomed')?.checked,
        Notes:     card.querySelector('.pet-notes')?.value?.trim() || ''
      };

      // Skip truly empty new cards
      if (!pet.PetID && !pet.Name && !pet.Species && !pet.Breed && !pet.Sex &&
          pet.AgeYrs === '' && pet.WeightLbs === '' && !pet.Fixed && !pet.Deceased &&
          !pet.Rehomed && !pet.Notes) return;

      out.push(pet);
    });
    return out;
  }

  async function loadExistingPets() {
    let clientRowId = '';
    try { clientRowId = sessionStorage.getItem('clientRowId') || ''; } catch(e){}
    if (!clientRowId || !window.clientsApi?.getPets) return;

    try {
      const res  = await new Promise((resolve, reject) => {
        clientsApi.getPets({ ClientRowId: clientRowId }, resolve, reject);
      });
      const list = Array.isArray(res?.pets) ? res.pets : [];

      // Fill up to 6 cards in given order (backend already filters out Deceased/Rehomed)
      list.slice(0, 6).forEach((p, i) => {
        const card = grid.querySelector(`.pet-card[data-idx="${i}"]`);
        if (card) fillCard(card, p);
      });
    } catch (err) {
      console.error('loadExistingPets failed', err);
    }
  }

  // Init
  buildGrid();
  loadExistingPets();

  // If the screen becomes visible later, refresh once
  const showObserver = new MutationObserver(() => {
    if (!scr.classList.contains('hidden')) {
      loadExistingPets();
    }
  });
  showObserver.observe(scr, { attributes: true, attributeFilter: ['class'] });

  // Back → just navigate (no save)
  scr.querySelector('[data-nav="supplies-client"]')?.addEventListener('click', () => {
    host.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    host.querySelector('#supplies-client')?.classList.remove('hidden');
  });

  // Continue → save pets → go to supplies-entry
  btn?.addEventListener('click', () => {
    let clientRowId = '';
    try { clientRowId = sessionStorage.getItem('clientRowId') || ''; } catch(e){}
    if (!clientRowId) { alert('Missing client record. Please go back and save client info first.'); return; }

    const pets = serializePets();
    disableBtn(btn, spin, true);

    const ok   = () => { disableBtn(btn, spin, false); showScreen('supplies-entry'); };
    const fail = (err) => { console.error(err); disableBtn(btn, spin, false); alert('Saving pets failed.'); };

    if (window.clientsApi?.savePets) {
      clientsApi.savePets({ ClientRowId: clientRowId, pets }, ok, fail);
    } else {
      setTimeout(ok, 150);
    }
  });
})();
</script>

<style>
  #supplies-pets .pet-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }
  #supplies-pets .card { border: 1px solid var(--border,#ddd); border-radius: 12px; padding: .75rem 1rem; }
  #supplies-pets .card.active { border-color: var(--accent,#3b82f6); box-shadow: 0 0 0 2px rgba(59,130,246,.15); }
  #supplies-pets .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
  #supplies-pets .disabled-fields { opacity:.6; }
  #supplies-pets .disabled-fields input,
  #supplies-pets .disabled-fields select,
  #supplies-pets .disabled-fields textarea { pointer-events:none; }
  #supplies-pets .spinner {
    display:none; width:16px; height:16px; border:2px solid transparent; border-top-color:currentColor; border-radius:50%;
    margin-left:.5rem; animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg);} }
</style>