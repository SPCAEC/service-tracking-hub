<section id="supplies-client" class="screen hidden" aria-labelledby="suppliesClientH2">
  <div class="section">
    <h2 id="suppliesClientH2">Food Pantry • Client Information</h2>

    <!-- live region for validation + search/save results -->
    <div id="clientMsg" class="msg" aria-live="polite"></div>

    <form id="clientForm" novalidate>
      <!-- SEARCH BAR -->
      <fieldset class="fieldset">
        <legend>Find Client</legend>
        <div class="grid cols-3">
          <div class="field">
            <label for="clientId">Client ID</label>
            <input id="clientId" name="clientId" type="text" placeholder="e.g., C-20250825-001 or PetPoint ID" />
            <div class="hint">Search by our Client ID or PetPoint ID (if already set).</div>
          </div>
          <div class="field">
            <label for="phone">Phone Number</label>
            <input id="phone" name="phone" type="tel" autocomplete="tel"
                   placeholder="(716) 555-1234" inputmode="tel" />
            <div class="hint">Enter phone <em>or</em> email and click Search.</div>
          </div>
          <div class="field">
            <label for="email">Email Address</label>
            <input id="email" name="email" type="email" autocomplete="email" placeholder="name@example.org" />
          </div>
        </div>
        <div class="controls" style="margin-top:.5rem">
          <button type="button" class="btn primary" id="btnClientSearch">
            <span class="btn-label">Search</span>
            <span class="spinner" aria-hidden="true" style="display:none;"></span>
          </button>
        </div>
      </fieldset>

      <!-- HIDDEN: holds sheet row id if we loaded an existing client -->
      <input type="hidden" id="rowId" name="rowId" value="" />

      <!-- CLIENT NAME -->
      <fieldset class="fieldset">
        <legend class="sr-only">Client Name</legend>
        <div class="grid cols-2">
          <div class="field">
            <label for="firstName">First Name <span aria-hidden="true">*</span></label>
            <input id="firstName" name="firstName" type="text" autocomplete="given-name" required />
            <div class="hint">Required</div>
          </div>
          <div class="field">
            <label for="lastName">Last Name <span aria-hidden="true">*</span></label>
            <input id="lastName" name="lastName" type="text" autocomplete="family-name" required />
            <div class="hint">Required</div>
          </div>
        </div>
      </fieldset>

      <!-- ADDRESS -->
      <fieldset class="fieldset">
        <legend class="sr-only">Address</legend>
        <div class="field">
          <label for="addr1">Address Line 1</label>
          <input id="addr1" name="addr1" type="text" autocomplete="address-line1" />
        </div>
        <div class="field">
          <label for="addr2">Address Line 2</label>
          <input id="addr2" name="addr2" type="text" autocomplete="address-line2" />
        </div>
        <div class="grid cols-3">
          <div class="field">
            <label for="city">City</label>
            <input id="city" name="city" type="text" autocomplete="address-level2" />
          </div>
          <div class="field">
            <label for="state">State</label>
            <input id="state" name="state" type="text" maxlength="2" placeholder="NY"
                   pattern="[A-Za-z]{2}" title="Use 2-letter state code" />
          </div>
          <div class="field">
            <label for="zip">ZIP</label>
            <input id="zip" name="zip" type="text" inputmode="numeric"
                   pattern="[0-9]{5}(-[0-9]{4})?" title="5 or 9 digit ZIP" placeholder="14224 or 14224-1234" />
          </div>
        </div>
      </fieldset>

      <!-- CONSENT -->
      <fieldset class="fieldset">
        <legend>Opt‑In Consent</legend>
        <div class="hint">
          Client consent to be contacted by the <strong>Pet Pantry</strong> about their pantry order and additional services.
        </div>
        <div class="grid cols-2">
          <label><input type="checkbox" id="consentEmail" name="consentEmail" /> Email Notifications</label>
          <label><input type="checkbox" id="consentSMS" name="consentSMS" /> Text (SMS) Notifications</label>
        </div>
      </fieldset>

      <!-- PET FLOW CHOICE -->
      <div class="section" style="border-style:dashed">
        <div class="field">
          <label>Do you have pet information to enter now?</label>
          <div class="controls" style="justify-content:flex-start;">
            <button type="button" class="btn primary" id="btnPetYes" data-next="supplies-pets">Yes, enter pet info</button>
            <button type="button" class="btn secondary" id="btnPetNo" data-next="supplies-items">No, continue to supplies</button>
          </div>
          <div class="hint">Either path will save client changes.</div>
        </div>
      </div>

      <div class="controls">
        <button type="button" class="btn secondary" data-nav="home">Back to Hub</button>
        <button type="submit" class="btn primary" id="saveClientNext">
          <span class="btn-label">Save Client</span>
          <span class="spinner" aria-hidden="true" style="display:none;"></span>
        </button>
      </div>
    </form>
  </div>
</section>

<script>
(() => {
  const scr = document.getElementById('supplies-client');
  if (!scr) return;

  const form = scr.querySelector('#clientForm');
  const msg  = scr.querySelector('#clientMsg');
  const saveBtn = scr.querySelector('#saveClientNext');
  const saveSpinner = saveBtn?.querySelector('.spinner');
  const searchBtn = scr.querySelector('#btnClientSearch');
  const searchSpinner = searchBtn?.querySelector('.spinner');

  // Inputs
  const clientId = scr.querySelector('#clientId');
  const phone = scr.querySelector('#phone');
  const email = scr.querySelector('#email');
  const zip   = scr.querySelector('#zip');
  const state = scr.querySelector('#state');
  const rowId = scr.querySelector('#rowId'); // hidden; stores RowId when we load an existing client

  const btnPetYes = scr.querySelector('#btnPetYes');
  const btnPetNo  = scr.querySelector('#btnPetNo');
  let nextScreenAfterSave = null; // 'supplies-pets' or 'supplies-items'
  let savingNow = false;          // guard against double-save

  // ---------- helpers
  const setMsg = (text, type='') => { msg.className = `msg ${type}`.trim(); msg.textContent = text || ''; };
  const disableBtn = (btn, spinner, on) => { if (!btn) return; btn.disabled = !!on; if (spinner) spinner.style.display = on ? 'inline-block' : 'none'; };
  const host = scr.closest('#app') || document;
  const showScreen = (id) => {
    host.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    host.querySelector('#'+id)?.classList.remove('hidden');
  };
  const toUSPhone = (v) => {
    const d = String(v||'').replace(/\D/g, '').slice(0,10);
    if (d.length < 4) return d;
    if (d.length < 7) return `(${d.slice(0,3)}) ${d.slice(3)}`;
    return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
  };
  const toUSZip = (v) => {
    const d = String(v || '').replace(/\D/g, '');
    if (d.length <= 5) return d;
    return `${d.slice(0,5)}-${d.slice(5,9)}`;
  };
  const truthy = (v) => (v === true || v === 'TRUE' || v === 'true' || v === 'Yes' || v === 'yes' || v === 1 || v === '1');

  // Serialize form -> object keyed to sheet headers
  const serialize = () => {
    const data = Object.fromEntries(new FormData(form).entries());

    const consentEmail = !!form.querySelector('#consentEmail')?.checked;
    const consentSMS   = !!form.querySelector('#consentSMS')?.checked;

    const phoneNorm = (phone.value || '').replace(/\D/g,'');
    const emailNorm = (email.value || '').trim().toLowerCase();

    const payload = {
      RowId:            data.rowId || '',                  // update if present
      ClientID:         (clientId.value || '').trim(),     // may be blank; backend will auto-generate on insert
      FirstName:        scr.querySelector('#firstName').value || '',
      LastName:         scr.querySelector('#lastName').value || '',
      Address1:         scr.querySelector('#addr1').value || '',
      Address2:         scr.querySelector('#addr2').value || '',
      City:             scr.querySelector('#city').value || '',
      State:            (state.value || '').toUpperCase(),
      ZIP:              zip.value || '',
      Phone:            phone.value || '',
      PhoneNormalized:  phoneNorm,
      Email:            email.value || '',
      EmailNormalized:  emailNorm,
      PreferredContact: data.PreferredContact || '',
      ConsentEmail:     consentEmail,
      ConsentSMS:       consentSMS
    };
    return payload;
  };

  // Fill form from object that uses sheet headers
  const fillForm = (c = {}) => {
    rowId.value = c.RowId || '';
    clientId.value = c.ClientID || '';
    const phoneDisplay = c.PhoneNormalized ? toUSPhone(c.PhoneNormalized) : (c.Phone || '');
    const emailDisplay = c.Email || c.EmailNormalized || '';

    phone.value = phoneDisplay || '';
    email.value = emailDisplay || '';

    scr.querySelector('#firstName').value = c.FirstName || '';
    scr.querySelector('#lastName').value  = c.LastName  || '';
    scr.querySelector('#addr1').value     = c.Address1  || '';
    scr.querySelector('#addr2').value     = c.Address2  || '';
    scr.querySelector('#city').value      = c.City      || '';
    state.value                           = (c.State || '').toUpperCase();
    zip.value                             = c.ZIP || '';

    scr.querySelector('#consentEmail').checked = truthy(c.ConsentEmail);
    scr.querySelector('#consentSMS').checked   = truthy(c.ConsentSMS);
  };

  // ---------- input niceties
  phone?.addEventListener('input', () => phone.value = toUSPhone(phone.value));
  zip?.addEventListener('input', () => zip.value = toUSZip(zip.value));
  state?.addEventListener('input', () => state.value = state.value.toUpperCase());

  // ---------- validation (minimal: require first/last on save)
  const validate = () => {
    const first = scr.querySelector('#firstName');
    const last  = scr.querySelector('#lastName');
    let ok = true;
    [first,last].forEach(el => {
      if (!el.value.trim()) { el.setAttribute('aria-invalid','true'); ok = false; }
      else el.removeAttribute('aria-invalid');
    });
    if (!ok) setMsg('Please enter first and last name.', 'error');
    return ok;
  };

  // ---------- search (via shim) — accepts ClientID OR Phone/Email
  searchBtn?.addEventListener('click', () => {
    setMsg('');
    const q = {
      ClientID: (clientId.value || '').trim(),
      PhoneNormalized: (phone.value || '').replace(/\D/g,''),
      EmailNormalized: (email.value || '').trim().toLowerCase()
    };
    if (!q.ClientID && !q.PhoneNormalized && !q.EmailNormalized) {
      setMsg('Enter Client ID, phone, or email, then click Search.', 'error');
      return;
    }
    disableBtn(searchBtn, searchSpinner, true);

    const onSuccess = (res) => {
      disableBtn(searchBtn, searchSpinner, false);

      if (res && res.found && res.client) {
        fillForm(res.client);
        rowId.value = res.client.RowId || '';

        // NEW: remember the matched client so downstream screens never auto-insert
        try {
          sessionStorage.setItem('clientRowId', String(res.client.RowId || ''));
          sessionStorage.setItem('clientClientID', String(res.client.ClientID || ''));
        } catch (e) {}

        setMsg('Client found. You can edit any fields before saving.', 'success');
      } else {
        rowId.value = '';

        // NEW: clear any stale stored id so pets screen won’t try to use it
        try {
          sessionStorage.removeItem('clientRowId');
          sessionStorage.removeItem('clientClientID');
        } catch (e) {}

        setMsg('No client found. Please enter details below, then save.', '');
      }
    };
    const onFailure = (err) => {
      console.error(err);
      disableBtn(searchBtn, searchSpinner, false);
      setMsg('Search failed. Please try again.', 'error');
    };

    clientsApi.search(q, onSuccess, onFailure);
  });

  // ---------- pet path choice (save + route)
  btnPetYes?.addEventListener('click', () => { nextScreenAfterSave = btnPetYes.dataset.next; form.requestSubmit(); });
  btnPetNo?.addEventListener('click',  () => { nextScreenAfterSave = btnPetNo.dataset.next;  form.requestSubmit(); });

  // ---------- Back to Hub
  scr.querySelector('[data-nav="home"]')?.addEventListener('click', () => showScreen('home'));

  // ---------- save (via shim) with double-submit guard + stash RowId
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (savingNow) return;
    setMsg('');
    if (!validate()) return;

    const payload = serialize();
    savingNow = true;
    disableBtn(saveBtn, saveSpinner, true);

    const onSuccess = (saved) => {
      disableBtn(saveBtn, saveSpinner, false);
      savingNow = false;

      if (saved && (saved.rowId || saved.RowId)) rowId.value = saved.rowId || saved.RowId;

      // Stash RowId for pets screen
      const rid = (saved && (saved.rowId || saved.RowId)) ? (saved.rowId || saved.RowId) : rowId.value;
      try { sessionStorage.setItem('clientRowId', String(rid || '')); } catch(e) {}

      // If backend assigned a ClientID (auto-generated), reflect it
      if (saved && saved.ClientID && !clientId.value) clientId.value = saved.ClientID;

      setMsg('Client saved.', 'success');
      document.dispatchEvent(new CustomEvent('client:saved', { detail: saved || payload }));
      showScreen(nextScreenAfterSave || 'supplies-items');
    };
    const onFailure = (err) => {
      console.error(err);
      disableBtn(saveBtn, saveSpinner, false);
      savingNow = false;
      setMsg('Save failed. Please try again.', 'error');
    };

    clientsApi.save(payload, onSuccess, onFailure);
  });
})();
</script>