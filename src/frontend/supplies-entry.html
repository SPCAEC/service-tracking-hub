<section id="supplies-entry" class="screen hidden" aria-labelledby="suppliesEntryH2">
  <div class="section">
    <h2 id="suppliesEntryH2">Food Pantry • Enter Supplies</h2>

    <div id="suppliesMsg" class="msg" aria-live="polite"></div>

    <div class="row">
      <div class="field">
        <label for="svcDate">Date Provided</label>
        <input id="svcDate" type="date" />
        <div class="hint">Format dd/mm/yyyy shown as your locale; stored as a date.</div>
      </div>
      <div class="field">
        <label for="deliveryType">Delivery Type</label>
        <select id="deliveryType">
          <option value="">—</option>
          <option value="Pickup">Pickup</option>
          <option value="Delivery">Delivery</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>

    <div class="section" style="border-style:dashed">
      <h3 style="margin:0 0 8px 0">Dog</h3>
      <div class="row">
        <div class="field"><label>Dry Dog Food (lbs)</label><input id="DryDogLbs" type="number" min="0" step="1"></div>
        <div class="field"><label>Wet Dog Food (cans)</label><input id="WetDogCans" type="number" min="0" step="1"></div>
        <div class="field"><label>Dog Treat(s)</label><input id="DogTreats" type="number" min="0" step="1"></div>
        <div class="field"><label>Dog Toy(s)</label><input id="DogToys" type="number" min="0" step="1"></div>
        <div class="field"><label>Dog Leash(es)</label><input id="DogLeashes" type="number" min="0" step="1"></div>
        <div class="field"><label>Dog Collar(s)</label><input id="DogCollars" type="number" min="0" step="1"></div>
      </div>

      <h3 style="margin:12px 0 8px 0">Cat</h3>
      <div class="row">
        <div class="field"><label>Dry Cat Food (lbs)</label><input id="DryCatLbs" type="number" min="0" step="1"></div>
        <div class="field"><label>Wet Cat Food (cans)</label><input id="WetCatCans" type="number" min="0" step="1"></div>
        <div class="field"><label>Cat Litter (lbs)</label><input id="CatLitterLbs" type="number" min="0" step="1"></div>
        <div class="field"><label>Cat Treat(s)</label><input id="CatTreats" type="number" min="0" step="1"></div>
        <div class="field"><label>Cat Toy(s)</label><input id="CatToys" type="number" min="0" step="1"></div>
        <div class="field"><label>Cat Collar(s)</label><input id="CatCollars" type="number" min="0" step="1"></div>
      </div>

      <h3 style="margin:12px 0 8px 0">Flea/Tick Meds</h3>
      <div class="row">
        <div class="field">
          <label for="ftQty">Qty (each)</label>
          <input id="ftQty" type="number" min="0" step="1">
        </div>
        <div class="field">
          <label for="ftSpecies">Species</label>
          <select id="ftSpecies">
            <option value="">—</option>
            <option>Dog</option>
            <option>Cat</option>
          </select>
        </div>
        <div class="field">
          <label for="ftBrand">Brand</label>
          <select id="ftBrand"><option value="">—</option></select>
          <div class="hint">Branded options come from Script Property <code>FLEA_TICK_BRANDS</code>.</div>
        </div>
        <div class="field">
          <label for="ftSize">Size</label>
          <select id="ftSize">
            <option value="">—</option>
            <option>Small-Medium</option>
            <option>Medium-Large</option>
            <option>Large-XL</option>
          </select>
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0">Other Items</h3>
      <div class="row">
        <div class="field"><label>Straw (# bales)</label><input id="StrawBales" type="number" min="0" step="1"></div>
        <div class="field"><label>Pet Bed (each)</label><input id="PetBeds" type="number" min="0" step="1"></div>
      </div>

      <div class="row">
        <div class="field" style="flex:1">
          <label>Other (free text)</label>
          <input id="OtherItemName" type="text" placeholder="e.g., Heat packs">
        </div>
        <div class="field"><label>Other Qty</label><input id="OtherQty" type="number" min="0" step="1"></div>
        <div class="field">
          <label>Other Unit</label>
          <select id="OtherUnit">
            <option>each</option>
            <option>lbs</option>
            <option>bale</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="orderNotes">Notes</label>
        <textarea id="orderNotes" rows="2" placeholder="Optional notes for this order…"></textarea>
      </div>
    </div>

    <div class="controls">
      <button type="button" class="btn secondary" data-nav="supplies-pets">Back to Pets</button>
      <button type="button" class="btn primary" id="saveSuppliesBtn">Save Supplies</button>
      <button type="button" class="btn" id="cancelSuppliesBtn">Cancel</button>
    </div>
    <!-- status / feedback message -->
    <div id="suppliesStatus" class="msg msg-inline hidden" aria-live="polite"></div>
  </div>
</section>

<script>
(() => {
  const scr = document.getElementById('supplies-entry');
  if (!scr) return;

  const msg = scr.querySelector('#suppliesMsg');
  const saveBtn = scr.querySelector('#saveSuppliesBtn');

  const setMsg = (t, type='') => { msg.className = `msg ${type}`.trim(); msg.textContent = t || ''; };
  const disable = (on) => { saveBtn.disabled = !!on; };

  // Populate flea/tick brand options from backend
  const ftBrand = scr.querySelector('#ftBrand');
  if (window.clientsApi) {
    clientsApi.getFleaTickBrands?.({}, (res) => {
      const arr = (res && res.brands) || [];
      ftBrand.innerHTML = '<option value="">—</option>' + arr.map(b => `<option>${b}</option>`).join('');
    }, console.error);
  }

  // Save handler
  saveBtn?.addEventListener('click', () => {
    setMsg('');
    // Date value (input type=date returns yyyy-mm-dd)
    const svcDate = scr.querySelector('#svcDate').value;

    let clientRowId = '';
    try { clientRowId = sessionStorage.getItem('clientRowId') || ''; } catch(e){}

    if (!clientRowId) {
      setMsg('No client selected. Please save client first.', 'error');
      return;
    }
    if (!svcDate) {
      setMsg('Please choose "Date Provided".', 'error');
      return;
    }

    const items = {
      DryDogLbs:    scr.querySelector('#DryDogLbs').value,
      WetDogCans:   scr.querySelector('#WetDogCans').value,
      DogTreats:    scr.querySelector('#DogTreats').value,
      DogToys:      scr.querySelector('#DogToys').value,
      DogLeashes:   scr.querySelector('#DogLeashes').value,
      DogCollars:   scr.querySelector('#DogCollars').value,

      DryCatLbs:    scr.querySelector('#DryCatLbs').value,
      WetCatCans:   scr.querySelector('#WetCatCans').value,
      CatLitterLbs: scr.querySelector('#CatLitterLbs').value,
      CatTreats:    scr.querySelector('#CatTreats').value,
      CatToys:      scr.querySelector('#CatToys').value,
      CatCollars:   scr.querySelector('#CatCollars').value,

      StrawBales:   scr.querySelector('#StrawBales').value,
      PetBeds:      scr.querySelector('#PetBeds').value
    };

    const fleaTick = {
      Qty:     scr.querySelector('#ftQty').value,
      Species: scr.querySelector('#ftSpecies').value,
      Brand:   scr.querySelector('#ftBrand').value,
      Size:    scr.querySelector('#ftSize').value
    };

    const otherItemName = scr.querySelector('#OtherItemName').value;
    const otherQty      = scr.querySelector('#OtherQty').value;
    const otherUnit     = scr.querySelector('#OtherUnit').value;

    const payload = {
      ClientRowId: clientRowId,
      ServiceDate: svcDate, // backend supports yyyy-mm-dd and dd/mm/yyyy
      DeliveryType: scr.querySelector('#deliveryType').value || '',
      Notes: scr.querySelector('#orderNotes').value || '',
      Items: items,
      FleaTick: fleaTick,
      Other: otherItemName ? { ItemName: otherItemName, Qty: otherQty, Unit: otherUnit } : ''
    };

    disable(true);
    clientsApi.saveOrder(payload, (res) => {
      disable(false);
      if (res && res.ok) {
        setMsg(`Order saved (OrderID ${res.orderId}) with ${res.lineCount} line(s).`, 'success');
        // You can navigate to a confirmation or back to hub here if desired
      } else {
        setMsg('Save failed. Please try again.', 'error');
      }
    }, (err) => {
      console.error(err);
      disable(false);
      setMsg('Save failed. Please try again.', 'error');
    });
  });

  // Nav
  scr.querySelector('[data-nav="supplies-pets"]')?.addEventListener('click', () => {
    (scr.closest('#app') || document).querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    (scr.closest('#app') || document).querySelector('#supplies-pets')?.classList.remove('hidden');
  });
})();
</script>