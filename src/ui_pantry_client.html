<script>
/**
 * Pantry Client screen controller (enhanced)
 * Adds:
 *  - Larger typography on edit forms
 *  - Wider grid & better wrapping for long labels/options
 *  - Blank/null option in every dropdown ("— Select —")
 *  - "Exit without save" to return to prior result view
 * Keeps:
 *  - Enter-to-search
 *  - Hidden backend fields in view/edit
 *  - Boolean icons in view, checkboxes in edit
 *  - Friendly labels
 *  - Server-driven dropdown options (with defaults)
 */

 // make checkboxes bigger (append this CSS block anywhere in this file or in shared_css)
const style = document.createElement('style');
style.textContent = `
  input[type="checkbox"].big-check { 
    width: 20px; height: 20px; 
    inline-size: 20px; block-size: 20px;
    transform: translateY(2px);
  }
  .hint { font-size: 12px; color: #64748b; margin-top: .25rem; }
  .readonly { background: #f8fafc; color:#475569; }
`;
document.head.appendChild(style);

(function () {
  // ---------- Config ----------
  const HIDE_IN_VIEW = ['PhoneNormalized', 'EmailNormalized'];
  const HIDE_IN_EDIT = ['PhoneNormalized', 'EmailNormalized'];
  const HIDE_IN_CREATE = ['PhoneNormalized', 'EmailNormalized', 'FirstSeenSource']; // 2 & 5

  const BOOL_FIELDS = ['ConsentSMS', 'ConsentEmail', 'Returning Client'];

  const DROPDOWN_FIELDS = [
    'PreferredContact',
    'How did you hear about us?',
    'Language',
    'Military Status',
    'Employment',
    'Ethnic Background',
    'Transportation',
    'Gender Identity',
    'Public Services',
    'Income',
    'Income Contribution',
    'Household Size',
    'Housing Status'
  ];

  // Friendly labels in both view and edit
  const LABELS = {
    PreferredContact: 'Preferred Contact Method',
    ConsentSMS: 'SMS Opt-In',
    ConsentEmail: 'Email Opt-In',
    FirstSeenAt: 'Date Client Created',
    FirstSeenSource: 'Original System of Client Creation'
  };

  // Fallback local options (used if the server doesn't provide any)
  const DEFAULT_OPTIONS = {
    PreferredContact: ['Text', 'Email'],
    'How did you hear about us?': [
      'Search engine','Website','Social Media','Flier','E-mail','Radio','TV','Newspaper',
      'Word of mouth','Walk-up','SPCA Staff','Other'
    ],
    Language: [
      'English','Spanish','Arabic','Chinese','French','German','Korean','Portuguese','Russian',
      'Vietnamese','Prefer not to answer','Other'
    ],
    'Military Status': ['Yes','No','Prefer not to answer'],
    Employment: ['Part-time','Full-time','Self-employed','Student','Retired','Unemployed','Prefer not to answer'],
    'Ethnic Background': [
      'White (Eg: German, Irish, English, Italian, Polish, French, etc)',
      'Hispanic, Latino or Spanish origin (Eg: Mexican..., Puerto Rican, etc)',
      'Black or African American (Eg: African American, Jamaican, Haitian, etc)',
      'Asian (Eg: Chinese, Filipino, Asian Indian, Vietnamese, Korean, Japanese, etc)',
      'American Indian or Alaska Native (...Navajo, Blackfeet, Mayan, Aztec, etc)',
      'Middle Eastern or North African (Eg: Lebanese, Iranian, Egyptian, etc)',
      'Native Hawaiian or Other Pacific Islander (Eg: Hawaiian, Samoan, etc)',
      'Some other race, ethnicity or origin',
      'Prefer not to answer'
    ],
    Transportation: [
      'Private vehicle (own/lease your own, friend or family member, etc)',
      'Public Transit','Bicycle','Walk','Prefer not to answer','Other'
    ],
    'Gender Identity': [
      'Male','Female','Transgender Male','Transgender Female',
      'Gender Variant/Non-Conforming','Non-binary','Not listed','Prefer not to answer'
    ],
    'Public Services': ['Yes','No','Prefer not to answer'],
    Income: ['$0-$30,000','$31,000-$60,000','$61,000-$90,000','$91,000-$120,000','$120,000 +','Prefer not to answer'],
    'Income Contribution': ['1','2','3','4','5+','Prefer not to answer'],
    'Household Size': ['1','2','3','4','5','6','7+','Prefer not to answer'],
    'Housing Status': [
      'I have stable, secure housing with my pet.',
      'My housing is in transition.',
      'I am currently unhoused with my pet.',
      'Prefer not to answer','Other'
    ]
  };

  // Will be filled on load from server, else fallback to DEFAULT_OPTIONS
  let OPTIONS = JSON.parse(JSON.stringify(DEFAULT_OPTIONS));

  // Persist last parsed server response for actions like Merge/Edit
  let LAST = null;

  const $ = (id) => document.getElementById(id);
  const displayLabel = (k) => LABELS[k] || k;

  // Inject one-time styles for the edit form (larger type, wider columns, better wrapping)
  function ensureEditStyles() {
    if (document.getElementById('pc-edit-styles')) return;
    const css = `
      .pc-edit {
        font-size: 1.08rem;
        line-height: 1.45;
      }
      .pc-edit .grid {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)) !important;
        gap: 1rem !important;
      }
      .pc-edit .field label {
        display:block;
        margin-bottom: .35rem;
        font-weight: 600;
        color: #334155;
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      .pc-edit input,
      .pc-edit select {
        font-size: 1.05rem;
        padding: .7rem .8rem;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        width: 100%;
      }
      /* Let long selected text and dropdown entries read comfortably */
      .pc-edit select {
        white-space: normal;     /* affects the closed select display */
        line-height: 1.35;
      }
      /* Some browsers ignore styling of <option>, but this helps where supported */
      .pc-edit select option {
        white-space: normal;
        line-height: 1.35;
        padding: .25rem .35rem;
      }
      .pc-edit .actions {
        display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.75rem;
      }
      .pc-edit .danger {
        background:#e11d48 !important;
      }
      .pc-edit .secondary {
        background:#e2e8f0 !important; color:#0f172a !important;
      }
    `.trim();
    const style = document.createElement('style');
    style.id = 'pc-edit-styles';
    style.textContent = css;
    document.head.appendChild(style);
  }

  // ---------- Event wiring ----------
  document.addEventListener('DOMContentLoaded', () => {
    const R = $('result');
    if (R) {
      R.innerHTML = `<div class="card" style="border-color:#10b981;">
        <strong>UI loaded</strong> @ ${new Date().toLocaleString()}
      </div>`;
    }

    // Fetch dropdown options (server may override defaults)
    if (API.getOptions) {
      API.getOptions((serverOpts) => {
        if (serverOpts && typeof serverOpts === 'object') {
          OPTIONS = Object.assign({}, DEFAULT_OPTIONS, serverOpts);
        }
        appendPing(R);
      });
    } else {
      appendPing(R);
    }

    // Wire buttons
    $('btnSearch')?.addEventListener('click', search);
    $('btnReset')?.addEventListener('click', reset);

    // Enter-to-search
    ['inpClientId','inpPhone','inpEmail','inpFormId'].forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') { ev.preventDefault(); search(); }
      });
    });
  });

  function appendPing(R) {
    API.ping((res) => {
      const pre = document.createElement('pre');
      pre.textContent = 'PING → ' + JSON.stringify(res, null, 2);
      R && R.appendChild(pre);
    });
  }

  function reset() {
    ['inpClientId', 'inpPhone', 'inpEmail', 'inpFormId'].forEach((id) => {
      const el = $(id);
      if (el) el.value = '';
    });
    const R = $('result');
    if (R) R.innerHTML = '';
    LAST = null;
  }

  // ---------- Actions ----------
  function search() {
    const q = {
      clientId: ($('inpClientId')?.value || '').trim(),
      phone: ($('inpPhone')?.value || '').trim(),
      email: ($('inpEmail')?.value || '').trim(),
    };
    const formId = ($('inpFormId')?.value || '').trim();

    if (formId) {
      API.searchByFormId(formId, (res) => {
        console.log('[searchByFormId] RES =', res);
        render(res);
      });
    } else {
      API.searchClient(q, (res) => {
        console.log('[searchClient] RES =', res);
        render(res);
      });
    }
  }

  // ---------- Render ----------
  function render(res){
    const R = $('result');
    if (!R) return;

    // If server wrapped payload as JSON, parse it
    let parsed = res;
    if (res && typeof res === 'object' && typeof res.resultJson === 'string') {
      try {
        parsed = JSON.parse(res.resultJson);
      } catch (e) {
        parsed = { status: 'error', where: 'client_parse', message: String(e) };
      }
    }

    // Keep for subsequent actions
    LAST = parsed;

    // Diagnostics
    const diag = { receivedAt: new Date().toISOString(), wrapper: res, parsed };
    R.innerHTML = `
      <div class="card" style="border-color:#94a3b8;">
        <h3 style="margin:0 0 .5rem;">Raw response</h3>
        <pre style="white-space:pre-wrap;">${escape(JSON.stringify(diag, null, 2))}</pre>
      </div>
    `;

    if (!parsed || typeof parsed !== 'object') return;

    if (parsed.status === 'error') {
      R.innerHTML += errorCard(parsed.where, parsed.message);
      return;
    }

    if (parsed.status === 'exact' && parsed.client) {
      R.innerHTML += cardExisting(parsed.client, { title: 'Client Found' });
      return;
    }

    if (parsed.status === 'possible_duplicate') {
      R.innerHTML += cardPossibleDup(parsed);
      return;
    }

    if (parsed.status === 'new_from_form') {
      R.innerHTML += cardEditOrCreate('create', parsed.candidateFromForm || {});
      return;
    }

    if (parsed.status === 'not_found' || parsed.status === 'form_not_found') {
      R.innerHTML += cardEditOrCreate('create', {});
      return;
    }

    R.innerHTML += `<pre>${escape(JSON.stringify(parsed, null, 2))}</pre>`;
  }

  // ---------- UI builders ----------
  function errorCard(where, message){
    return `
      <div class="card" style="border-color:#ef4444;">
        <h3 style="margin:0 0 .5rem;">Server error ${where ? '('+escape(where)+')' : ''}</h3>
        <pre style="white-space:pre-wrap;">${escape(message || '')}</pre>
      </div>`;
  }

  function cardExisting(c, opts) {
    return `
      <div class="card">
        <h3 style="margin:0 0 .5rem;">${(opts && opts.title) || 'Client'}</h3>
        ${tableFields(c)}
        <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap: wrap;">
          <button type="button" onclick="UI_PC.editExisting()">Edit</button>
          <button type="button" onclick="UI_PC.continue()">Continue</button>
        </div>
      </div>
    `;
  }

  function cardPossibleDup(res) {
    const left  = res.client || {};
    const right = res.candidateFromForm || {};
    const reasons = Array.isArray(res.matchReasons) ? res.matchReasons.join(' + ') : '';
    return `
      <div class="card">
        <h3 style="margin:0 0 .5rem;">Possible duplicate ${reasons ? '(' + escape(reasons) + ')' : ''}</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div><h4 style="margin:.25rem 0;">Existing</h4>${tableFields(left)}</div>
          <div><h4 style="margin:.25rem 0;">From Form</h4>${tableFields(right)}</div>
        </div>
        <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap: wrap;">
          <button type="button" onclick="UI_PC.useExisting()">Use Existing</button>
          <button type="button" onclick="UI_PC.merge()">Merge & Save</button>
          <button type="button" class="secondary" onclick="UI_PC.createFromForm()">Create Separate Client</button>
        </div>
      </div>
    `;
  }

  // Edit/Create form with larger text, wider layout, blank dropdown option, and cancel
  function cardEditOrCreate(mode, seed){
    ensureEditStyles();

    const isEdit = mode === 'edit';
    const fields = [
      'ClientID','FirstName','LastName','Address1','Address2','City','State','ZIP',
      'Phone','PhoneNormalized','Email','EmailNormalized',
      'PreferredContact','ConsentEmail','ConsentSMS','Returning Client',
      'FirstSeenAt','FirstSeenSource',
      'How did you hear about us?','Language','Military Status','Employment','Ethnic Background',
      'Transportation','Gender Identity','Public Services','Income','Income Contribution',
      'Household Size','Housing Status'
    ];

    const isCreate = !isEdit;
    const shouldHide = (field) =>
      (isEdit  && HIDE_IN_EDIT.includes(field)) ||
      (isCreate && HIDE_IN_CREATE.includes(field));

    const init = {};
    fields.forEach(k => init[k] = seed && seed[k] != null ? seed[k] : '');

    const rows = fields.map((k) => {
      // ClientID: add hint only in CREATE mode
      if (k === 'ClientID') {
        const required = ''; // never required
        const val = escapeAttr(value || '');
        const hint = isCreate ? `<div class="hint">Leave blank unless PetPoint Person ID is known</div>` : '';
        return `
          <div class="field">
            <label>${escape(displayLabel(k))}${required ? ' *' : ''}</label>
            <input name="ClientID" value="${val}">
            ${hint}
          </div>
        `;
      }

      // FirstSeenAt: show, prefill now on CREATE, readonly & greyed
      if (k === 'FirstSeenAt') {
        const valISO = value || new Date().toISOString();
        return `
          <div class="field">
            <label>${escape(displayLabel(k))}</label>
            <input name="FirstSeenAt" value="${escapeAttr(valISO)}" readonly class="readonly">
          </div>
        `;
      }

      if (shouldHide(k)) return '';

      const label = displayLabel(k);
      const nameAttr = k;
      const value = init[k];

      if (BOOL_FIELDS.includes(k)) {
        const checked = truthy(value) ? 'checked' : '';
        return `
          <div class="field">
            <label>${escape(label)}</label>
            <input type="checkbox" class="big-check" name="${escapeAttr(nameAttr)}" ${checked}>
          </div>`;
      }

      if (DROPDOWN_FIELDS.includes(k)) {
        const opts = optionsFor(k);
        const hasOther = opts.includes('Other') || /Other\b/i.test(opts.join('||'));
        const sel = selectHTML(nameAttr, value, opts, hasOther, /*includeBlank*/ true);
        return `
          <div class="field">
            <label>${escape(label)}</label>
            ${sel}
          </div>`;
      }

      const required = (k === 'FirstName' || k === 'LastName') ? 'required' : '';
      return `
        <div class="field">
          <label>${escape(label)}${required ? ' *' : ''}</label>
          <input name="${escapeAttr(nameAttr)}" value="${escapeAttr(value)}" ${required}>
        </div>`;
    }).join('');

    // Buttons: Save + Exit without save (cancel)
    return `
      <div class="card pc-edit">
        <h3 style="margin:0 0 .5rem;">${isEdit ? 'Edit Client' : (seed && (seed.FirstName || seed.LastName) ? 'Review or Create Client' : 'Create New Client')}</h3>
        <form id="formClient" onsubmit="return false;">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1rem;">
            ${rows}
          </div>
        </form>
        <div class="actions">
          ${isEdit
            ? `<button type="button" onclick="UI_PC.saveEdit()">Save</button>
               <button type="button" class="secondary" onclick="UI_PC.cancelEdit()">Exit without save</button>`
            : `<button type="button" onclick="UI_PC.saveNew()">Create Client</button>
               <button type="button" class="secondary" onclick="UI_PC.cancelEdit()">Exit without save</button>`
          }
        </div>
      </div>
    `;
  }

  function tableFields(c) {
    const fields = [
      'ClientID','FirstName','LastName','Address1','Address2','City','State','ZIP',
      'Phone','PhoneNormalized','Email','EmailNormalized',
      'PreferredContact','ConsentEmail','ConsentSMS','Returning Client',
      'FirstSeenAt','FirstSeenSource',
      'How did you hear about us?','Language','Military Status','Employment','Ethnic Background',
      'Transportation','Gender Identity','Public Services','Income','Income Contribution',
      'Household Size','Housing Status'
    ];
    const rows = fields.map((k) => {
      if (HIDE_IN_VIEW.includes(k)) return '';
      const label = displayLabel(k);
      const raw = c && c[k] != null ? c[k] : '';

      if (BOOL_FIELDS.includes(k)) {
        const on = truthy(raw);
        const icon = on ? '✔️' : '❌';
        const sr = on ? 'Yes' : 'No';
        return rowHTML(label, `<span aria-label="${sr}">${icon}</span>`);
      }
      return rowHTML(label, escape(String(raw)));
    }).join('');

    return `
      <table style="width:100%; border-collapse:collapse;">
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // ---------- Exposed actions ----------
  window.UI_PC = {
    editExisting() {
      if (!LAST || !LAST.client) { APP.toast('Nothing to edit.'); return; }
      const R = $('result');
      R.innerHTML = cardEditOrCreate('edit', LAST.client);
    },

    // "Exit without save" → restore previous view
    cancelEdit() {
      const R = $('result');
      if (!R || !LAST) { reset(); return; }
      // Re-render from LAST status
      R.innerHTML = `
        <div class="card" style="border-color:#94a3b8;">
          <h3 style="margin:0 0 .5rem;">Raw response</h3>
          <pre style="white-space:pre-wrap;">${escape(JSON.stringify({receivedAt:new Date().toISOString(), parsed: LAST}, null, 2))}</pre>
        </div>
      `;
      if (LAST.status === 'exact' && LAST.client) {
        R.innerHTML += cardExisting(LAST.client, { title: 'Client Found' });
      } else if (LAST.status === 'possible_duplicate') {
        R.innerHTML += cardPossibleDup(LAST);
      } else if (LAST.status === 'new_from_form') {
        R.innerHTML += cardEditOrCreate('create', LAST.candidateFromForm || {});
      } else if (LAST.status === 'not_found' || LAST.status === 'form_not_found') {
        R.innerHTML += cardEditOrCreate('create', {});
      } else {
        R.innerHTML += `<pre>${escape(JSON.stringify(LAST, null, 2))}</pre>`;
      }
    },

    saveEdit() {
      const data = formToObject('formClient');
      normalizeClient(data);
      API.createClient(data, () => { APP.toast('Client updated.'); reset(); });
    },

    saveNew() {
      const data = formToObject('formClient');
      if (!data.FirstName || !data.LastName) { APP.toast('First and Last Name are required.'); return; }
      normalizeClient(data);
      API.createClient(data, () => { APP.toast('Client created.'); reset(); });
    },

    continue() {
      APP.toast('Continue to Pets (coming next)…');
    },

    useExisting() {
      APP.toast('Using existing client. Continue to Pets…');
    },

    merge() {
      if (!LAST || !LAST.client || !LAST.candidateFromForm) {
        APP.toast('No merge candidates.');
        return;
      }
      API.mergeClient(LAST.client, LAST.candidateFromForm, (merged) => {
        API.createClient(merged, () => { APP.toast('Merged & saved.'); reset(); });
      });
    },

    createFromForm() {
      if (!LAST || !LAST.candidateFromForm) { APP.toast('No form candidate.'); return; }
      const data = Object.assign({}, LAST.candidateFromForm);
      normalizeClient(data);
      API.createClient(data, () => { APP.toast('Client created from form.'); reset(); });
    }
  };

  // ---------- Helpers ----------
  function rowHTML(label, valueHTML){
    return `
      <tr>
        <td style="padding:.25rem .5rem; color:#475569; width:260px;">${escape(label)}</td>
        <td style="padding:.25rem .5rem;">${valueHTML}</td>
      </tr>`;
  }

  // includeBlank = true → prepends a blank option "— Select —"
  function selectHTML(name, value, opts, allowOther, includeBlank){
    const id = slug(name);
    const selected = (v) => (String(v) === String(value) ? 'selected' : '');
    const blankSelected = !value || (value && !opts.includes(String(value)) && !allowOther);
    const blankHTML = includeBlank ? `<option value="" ${blankSelected ? 'selected' : ''}>— Select —</option>` : '';
    const optionsHTML = opts.map(o => `<option value="${escapeAttr(o)}" ${selected(o)} title="${escapeAttr(o)}">${escape(o)}</option>`).join('');
    const otherId = `${id}__other`;
    const showOther = allowOther && String(value).trim() && !opts.includes(String(value));
    return `
      <select name="${escapeAttr(name)}" id="${escapeAttr(id)}" data-has-other="${allowOther ? '1':'0'}" onchange="(function(sel){ 
        const hasOther=sel.dataset.hasOther==='1';
        const o=document.getElementById('${escapeAttr(otherId)}');
        if(!o) return;
        if(hasOther && sel.value==='Other'){ o.style.display='block'; o.disabled=false; o.focus(); }
        else { o.style.display='none'; o.disabled=true; if(sel.value!=='Other'){ o.value=''; } }
      })(this)">
        ${blankHTML}
        ${optionsHTML}
      </select>
      ${allowOther ? `
        <input id="${escapeAttr(otherId)}" placeholder="Please specify" style="margin-top:.25rem;${showOther?'':'display:none;'}" ${showOther?'':'disabled'}
               value="${showOther ? escapeAttr(value) : ''}">
      `:''}
    `;
  }

  function optionsFor(field){
    const o = OPTIONS && OPTIONS[field];
    return Array.isArray(o) && o.length ? o.slice() : (DEFAULT_OPTIONS[field] || []);
  }

  function truthy(v){
    if (typeof v === 'boolean') return v;
    const s = String(v).toLowerCase().trim();
    return ['true','yes','y','1','checked'].includes(s);
  }

  function formToObject(formId) {
    const root = document.getElementById(formId);
    const o = {};
    if (!root) return o;

    // inputs (text/email/etc.)
    root.querySelectorAll('input[name]').forEach((i) => {
      if (i.type === 'checkbox') {
        o[i.name] = !!i.checked;
      } else if (i.id && i.id.endsWith('__other') && i.disabled) {
        // ignore hidden other-input if disabled
      } else {
        o[i.name] = i.value || '';
      }
    });

    // selects (+ other text if visible)
    root.querySelectorAll('select[name]').forEach((s) => {
      const val = s.value;
      const other = document.getElementById(`${s.id}__other`);
      if (val === 'Other' && other && !other.disabled && other.style.display !== 'none') {
        o[s.name] = other.value || '';
      } else {
        o[s.name] = val || '';
      }
    });

    return o;
  }

  function normalizeClient(o) {
    if (o.Email && !o.EmailNormalized) o.EmailNormalized = String(o.Email).toLowerCase();
    if (o.Phone && !o.PhoneNormalized) {
      const digits = String(o.Phone).replace(/\D/g,'');
      o.PhoneNormalized = digits.length >= 10 ? digits.slice(-10) : digits;
    }
  }

  function slug(s){ return String(s).replace(/\s+/g,'_').replace(/[^\w\-]/g,'').toLowerCase(); }

  function escape(s) {
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s) {
    return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
})();
</script>